organism = "hsa",
ppi_limit = NULL,
contact_LLM = FALSE,
api_key = "1443cf91-00bd-4c0d-b532-284ed5afec11",
model="deepseek-r1-250528")
prompt <- interpret_tool(enrich_res = go_res,
diff_genes = diff_genes,
pathway_num = 30,
context = "786-0 cells were treated with either a control DMSO vehicle or 10um Everolimus, an mTOR inhibitor, for 4 hours.",
ppi = TRUE,
organism = "hsa",
ppi_limit = NULL,
contact_LLM = FALSE,
api_key = "1443cf91-00bd-4c0d-b532-284ed5afec11",
model="deepseek-r1-250528")
head(prompt)
prompt
？writeLines
、writeLines
?writeLines
writeLines(prompt, "prompt.txt", sep = "\n", useBytes = TRUE)
prompt <- interpret_tool(enrich_res = kegg_res,
diff_genes = diff_genes,
pathway_num = 30,
context = "786-0 cells were treated with either a control DMSO vehicle or 10um Everolimus, an mTOR inhibitor, for 4 hours.",
ppi = TRUE,
organism = "hsa",
ppi_limit = NULL,
contact_LLM = FALSE,
api_key = "1443cf91-00bd-4c0d-b532-284ed5afec11",
model="deepseek-r1-250528")
writeLines(prompt, "prompt.txt", sep = "\n", useBytes = TRUE)
counts <- qs::qread("RNA_seq_upstream/GSE99875/02_annotated_expression_matrices/counts.qs")
metadata <- read.csv("RNA_seq_upstream/GSE99875/resource/SraRunTable.csv") %>% dplyr::select(GEO_Accession..exp., treatment)
colnames(metadata) <- c("sample", "group")
metadata$group <- factor(ifelse(metadata$group == "Control", "control", "treat"), levels = c("control", "treat"))
qs::qsave(metadata, file = "analysis/resource/GSE99875_metadata.qs")
#### Identify differentially expressed genes ####
dds <- DESeqDataSetFromMatrix(countData = counts,
colData = metadata,
design = ~ group)
dds <- DESeq(dds)
contrast = c("group", "treat", "control")
dd1 <- results(dds, contrast = contrast, alpha = 0.05)
plotMA(dd1, ylim = c(-10, 10))
dd2 <- lfcShrink(dds, contrast = contrast, res = dd1, type = "ashr")
plotMA(dd2, ylim = c(-10, 10))
deg_res <- dd2 %>%
as.data.frame() %>%
dplyr::arrange(desc(log2FoldChange)) %>%
rownames_to_column("gene")
gene_mapping <- bitr(deg_res$gene,
fromType = "SYMBOL",
toType = "ENTREZID",
OrgDb = "org.Hs.eg.db")
colnames(gene_mapping) <- c("gene", "entrez")
gene_df <- deg_res %>% dplyr::inner_join(gene_mapping, by = "gene")
entrez_list <- gene_df$log2FoldChange
names(entrez_list) <- gene_df$entrez
entrez_list <- sort(entrez_list, decreasing = TRUE)
##### KEGG #####
gsea_kegg_res <- gseKEGG(geneList     = entrez_list,
organism     = 'hsa',
minGSSize    = 0,
maxGSSize    = 1000000,
pvalueCutoff = 0.05,
verbose      = TRUE)
gsea_kegg_res <- setReadable(gsea_kegg_res,
OrgDb = "org.Hs.eg.db",
keyType = "ENTREZID")
gsea_kegg_res@result <- subset(gsea_kegg_res@result, NES > 0 & p.adjust < 0.05)
kegg_res_dat <- as.data.frame(gsea_kegg_res) %>% arrange(desc(NES))
View(kegg_res_dat)
qs::qsave(kegg_res, file = "analysis/data/02_Everolimus_signature_scoring/01_determine_ERGs/03_gsea_kegg.qs")
qs::qsave(gsea_kegg_res, file = "analysis/data/02_Everolimus_signature_scoring/01_determine_ERGs/03_gsea_kegg.qs")
dev.off()
?gseWP
?GSEA
?gsePathway
library(ReactomePA)
Sys.setenv(http_proxy = "http://iyun70.com:7890")
Sys.setenv(https_proxy = "http://iyun70.com:7890")
BiocManager::install("ReactomePA", force = T, update = F, ask = F)
BiocManager::install("DOSE", force = T, update = F, ask = F)
BiocManager::install("ReactomePA", force = T, update = F, ask = F)
setwd("/media/desk16/iyun4605/projects/Everolimus_Resistance_ccRCC/RNA_seq_upstream/GSE99875")
#### Load packages and functions ####
library(tidyverse)
library(GenomicFeatures)
library(DESeq2)
library(ggplot2)
library(ggrepel)
make_counts <- function(all_samples_dir){
all_dfs <- list()
for (file in all_samples_dir) {
cat("Sample: ", file, "\n")
file_name <- sub("01_read_align/", "", file)
# file_name <- sub("_ReadsPerGene.out.tab", "", file_name)
tmp_df <- read.table(paste0(file, "/", file_name, "_ReadsPerGene.out.tab"))
tmp_df <- tmp_df[c(-1, -2, -3, -4), c(1, 4)]
colnames(tmp_df) <- c("gene_id", file_name)
all_dfs[[file_name]] <- tmp_df
}
counts <- Reduce(function(x, y) merge(x, y, by = "gene_id", all = TRUE), all_dfs)
return(counts)
}
Run_pca <- function(counts_matrix, group_vector, group_levels, contrast, plot_title){
counts_matrix <- counts_matrix %>% column_to_rownames("gene_id")
metadata <- data.frame(
sample = colnames(counts_matrix),
group = factor(group_vector, levels = group_levels)
)
print(metadata)
dds <- DESeqDataSetFromMatrix(
countData = counts_matrix,
colData = metadata,
design = ~ group,
tidy = FALSE
)
dds <- dds[rowSums(counts(dds)) > 1, ]
vsd <- vst(dds, blind = FALSE)
pca_data <- plotPCA(vsd, intgroup="group", returnData=TRUE)
p <- ggplot(pca_data, aes(x = PC1, y = PC2, color = group)) +
geom_point(size = 3) +
geom_text_repel(aes(label = name),
box.padding = 0.5,
point.padding = 0.3) +
labs(title = plot_title,
x = paste0("PC1: ", round(attr(pca_data, "percentVar")[1] * 100), "% variance"),
y = paste0("PC2: ", round(attr(pca_data, "percentVar")[2] * 100), "% variance"))+
theme_bw()+
theme(plot.title = element_text(hjust = 0.5,
face = "bold",
size = 16,
color = "black"))
return(p)
}
Counts2TPM <- function(counts_matrix, TxDb = txdb){
exonic <- exonsBy(TxDb, by="gene")
exonic.gene.sizes <- sum(width(GenomicRanges::reduce(exonic)))
mygeneids <- data.frame(gene_id=names(exonic.gene.sizes), width=exonic.gene.sizes)
data = merge(counts_matrix, mygeneids, by="gene_id")
data <- data %>% column_to_rownames("gene_id")
geneLengths <- data$width
rpk <- apply( X = subset(data, select = colnames(data)[colnames(data) != "width"]),
MARGIN =2,
FUN = function(x){
x/(geneLengths/1000)
})
tpm <- apply(X = rpk,
MARGIN = 2,
FUN = function(x){
x / sum(as.numeric(x)) * 10^6
})
tpm_log2 <- log2(tpm+1)
tpm_log2 <- tpm_log2 %>% as.data.frame() %>% rownames_to_column("gene_id")
return(tpm_log2)
}
Run_annotation <- function(gtf_inf, matrix){
gtf_protein_coding <- gtf_inf %>%
dplyr::filter(type == "gene") %>%
dplyr::filter(gene_type=="protein_coding") %>%
dplyr::select(gene_name, gene_id)
matrix_anno <- matrix %>%
merge(gtf_protein_coding, ., by = "gene_id") %>%
dplyr::select(-gene_id) %>%
mutate(rowmean = rowMeans(.[-1])) %>%
arrange(desc(rowmean)) %>%
distinct(gene_name, .keep_all = T) %>%
dplyr::select(-rowmean)
matrix_anno <- matrix_anno %>% column_to_rownames("gene_name")
return(matrix_anno)
}
#### Load data and process ####
gtf <- rtracklayer::import('/media/desk16/iyun4605/public_data/genome_files/GRCh38_gtf/gencode.v49.annotation.gtf') %>% as.data.frame
txdb <- makeTxDbFromGFF('/media/desk16/iyun4605/public_data/genome_files/GRCh38_gtf/gencode.v49.annotation.gtf')
all_samples <- list.files("01_read_align",
full.names=TRUE)
metadata <- read.csv("resource/SraRunTable.csv")
metadata <- metadata %>% dplyr::select(Sample.Name, treatment)
colnames(metadata) <- c("sample", "group")
metadata$group <- ifelse(metadata$group == "4hr Everolimus", "Everolimus", "Control")
View(metadata)
qs::qsave(metadata, file = "resource/metadata.qs")
#### Read count ####
counts <- make_counts(all_samples_dir = all_samples)
counts <- counts[, c("gene_id", metadata$sample)]
qs::qsave(counts, file = "02_annotated_expression_matrices/counts_noanno.qs")
#### PCA plot ####
p <- Run_pca(counts_matrix = counts,
group_vector = metadata$group,
group_levels = c("Control", "Everolimus"),
contrast = c("group", "Everolimus", "Control"),
plot_title = NULL)
p
ggsave(filename = "02_annotated_expression_matrices/pca.pdf", p, height = 10, width = 10)
#### Count2TPM ####
tpm_log2 <- Counts2TPM(counts_matrix = counts, TxDb = txdb)
#### vst ####
vsd <- vst(as.matrix(counts))
View(counts)
any(counts < 0, na.rm = TRUE)
#### vst ####
vsd <- vst(as.matrix(counts))
View(counts)
?DESeqDataSetFromMatrix
View(counts)
#### vst ####
dds <- DESeqDataSetFromMatrix(countData = counts,
colData = metadata,
design = ~ group,
tidy = FALSE)
#### vst ####
dds <- DESeqDataSetFromMatrix(countData = counts,
colData = metadata,
design = ~ group,
tidy = TRUE)
vsd <- assay(vst(dds, blind = FALSE))
vsd <- assay(vst(dds, blind = FALSE)) %>% as.data.frame()
View(vsd)
vsd <- assay(vst(dds, blind = FALSE)) %>% as.data.frame() %>% rownames_to_column("gene_id")
#### Annotation ####
counts_anno <- Run_annotation(gtf_inf = gtf, matrix = counts)
tpm_log2_anno <- Run_annotation(gtf_inf = gtf, matrix = tpm_log2)
vsd_anno <- Run_annotation(gtf_inf = gtf, matrix = vsd)
identical(rownames(vsd_anno), rownames(counts))
identical(rownames(vsd_anno), rownames(counts_anno))
setequal(rownames(vsd_anno), rownames(counts_anno))
qs::qsave(vsd_anno, file = "02_annotated_expression_matrices/vsd.qs")
qs::qsave(counts_anno, file = "02_annotated_expression_matrices/counts.qs")
qs::qsave(tpm_log2_anno, file = "02_annotated_expression_matrices/tpm_log2.qs")
qs::qsave(vsd_anno, file = "02_annotated_expression_matrices/vsd.qs")
setwd("/media/desk16/iyun4605/projects/Everolimus_Resistance_ccRCC/RNA_seq_upstream/GSE242110")
setwd("/media/desk16/iyun4605/projects/Everolimus_Resistance_ccRCC/RNA_seq_upstream/GSE242110")
#### Load packages and functions ####
library(tidyverse)
library(GenomicFeatures)
library(DESeq2)
library(ggplot2)
library(ggrepel)
make_counts <- function(all_samples_dir){
all_dfs <- list()
for (file in all_samples_dir) {
cat("Sample: ", file, "\n")
file_name <- sub("01_read_align/", "", file)
# file_name <- sub("_ReadsPerGene.out.tab", "", file_name)
tmp_df <- read.table(paste0(file, "/", file_name, "_ReadsPerGene.out.tab"))
tmp_df <- tmp_df[c(-1, -2, -3, -4), c(1, 4)]
colnames(tmp_df) <- c("gene_id", file_name)
all_dfs[[file_name]] <- tmp_df
}
counts <- Reduce(function(x, y) merge(x, y, by = "gene_id", all = TRUE), all_dfs)
return(counts)
}
Run_pca <- function(counts_matrix, group_vector, group_levels, contrast, plot_title){
counts_matrix <- counts_matrix %>% column_to_rownames("gene_id")
metadata <- data.frame(
sample = colnames(counts_matrix),
group = factor(group_vector, levels = group_levels)
)
print(metadata)
dds <- DESeqDataSetFromMatrix(
countData = counts_matrix,
colData = metadata,
design = ~ group,
tidy = FALSE
)
dds <- dds[rowSums(counts(dds)) > 1, ]
vsd <- vst(dds, blind = FALSE)
pca_data <- plotPCA(vsd, intgroup="group", returnData=TRUE)
p <- ggplot(pca_data, aes(x = PC1, y = PC2, color = group)) +
geom_point(size = 3) +
geom_text_repel(aes(label = name),
box.padding = 0.5,
point.padding = 0.3) +
labs(title = plot_title,
x = paste0("PC1: ", round(attr(pca_data, "percentVar")[1] * 100), "% variance"),
y = paste0("PC2: ", round(attr(pca_data, "percentVar")[2] * 100), "% variance"))+
theme_bw()+
theme(plot.title = element_text(hjust = 0.5,
face = "bold",
size = 16,
color = "black"))
return(p)
}
Counts2TPM <- function(counts_matrix, TxDb = txdb){
exonic <- exonsBy(TxDb, by="gene")
exonic.gene.sizes <- sum(width(GenomicRanges::reduce(exonic)))
mygeneids <- data.frame(gene_id=names(exonic.gene.sizes), width=exonic.gene.sizes)
data = merge(counts_matrix, mygeneids, by="gene_id")
data <- data %>% column_to_rownames("gene_id")
geneLengths <- data$width
rpk <- apply( X = subset(data, select = colnames(data)[colnames(data) != "width"]),
MARGIN =2,
FUN = function(x){
x/(geneLengths/1000)
})
tpm <- apply(X = rpk,
MARGIN = 2,
FUN = function(x){
x / sum(as.numeric(x)) * 10^6
})
tpm_log2 <- log2(tpm+1)
tpm_log2 <- tpm_log2 %>% as.data.frame() %>% rownames_to_column("gene_id")
return(tpm_log2)
}
Run_annotation <- function(gtf_inf, matrix){
gtf_protein_coding <- gtf_inf %>%
dplyr::filter(type == "gene") %>%
dplyr::filter(gene_type=="protein_coding") %>%
dplyr::select(gene_name, gene_id)
matrix_anno <- matrix %>%
merge(gtf_protein_coding, ., by = "gene_id") %>%
dplyr::select(-gene_id) %>%
mutate(rowmean = rowMeans(.[-1])) %>%
arrange(desc(rowmean)) %>%
distinct(gene_name, .keep_all = T) %>%
dplyr::select(-rowmean)
matrix_anno <- matrix_anno %>% column_to_rownames("gene_name")
return(matrix_anno)
}
#### Load data and process ####
gtf <- rtracklayer::import('/media/desk16/iyun4605/public_data/genome_files/GRCh38_gtf/gencode.v49.annotation.gtf') %>% as.data.frame
txdb <- makeTxDbFromGFF('/media/desk16/iyun4605/public_data/genome_files/GRCh38_gtf/gencode.v49.annotation.gtf')
all_samples <- list.files("01_read_align",
full.names=TRUE)
metadata <- read.csv("resource/SraRunTable.csv")
metadata <- metadata %>% dplyr::select(Sample.Name, treatment)
colnames(metadata) <- c("sample", "group")
metadata <- metadata %>% filter(group %in% c("5uM Everolimus", "DMSO"))
metadata$group <- ifelse(metadata$group == "5uM Everolimus", "Everolimus", "Control")
View(metadata)
metadata <- read.csv("resource/SraRunTable.csv")
metadata <- metadata %>% dplyr::select(Sample.Name, treatment)
View(metadata)
colnames(metadata) <- c("sample", "group")
metadata <- metadata %>% filter(group %in% c("5uM Everolimus", "DMSO"))
View(metadata)
metadata$group <- ifelse(metadata$group == "5uM Everolimus", "Everolimus", "Control")
qs::qsave(metadata, file = "resource/metadata.qs")
counts <- make_counts(all_samples_dir = all_samples)
counts <- counts[, c("gene_id", metadata$sample)]
qs::qsave(counts, file = "02_annotated_expression_matrices/counts_noanno.qs")
#### PCA plot ####
p <- Run_pca(counts_matrix = counts,
group_vector = metadata$group,
group_levels = c("Control", "Everolimus"),
contrast = c("group", "Everolimus", "Control"),
plot_title = NULL)
p
ggsave(filename = "02_annotated_expression_matrices/pca.pdf", p, height = 10, width = 10)
#### Count2TPM ####
tpm_log2 <- Counts2TPM(counts_matrix = counts, TxDb = txdb)
View(counts)
#### vst ####
dds <- DESeqDataSetFromMatrix(countData = counts,
colData = metadata,
design = ~ group,
tidy = TRUE)
vsd <- assay(vst(dds, blind = FALSE)) %>% as.data.frame() %>% rownames_to_column("gene_id")
metadata$group <- factor(metadata$group, levels = c("Control", "Everolimus"))
metadata <- read.csv("resource/SraRunTable.csv")
metadata <- metadata %>% dplyr::select(Sample.Name, treatment)
colnames(metadata) <- c("sample", "group")
metadata <- metadata %>% filter(group %in% c("5uM Everolimus", "DMSO"))
metadata$group <- ifelse(metadata$group == "5uM Everolimus", "Everolimus", "Control")
metadata$group <- factor(metadata$group, levels = c("Control", "Everolimus"))
qs::qsave(metadata, file = "resource/metadata.qs")
#### vst ####
dds <- DESeqDataSetFromMatrix(countData = counts,
colData = metadata,
design = ~ group,
tidy = TRUE)
vsd <- assay(vst(dds, blind = FALSE)) %>% as.data.frame() %>% rownames_to_column("gene_id")
#### Annotation ####
counts_anno <- Run_annotation(gtf_inf = gtf, matrix = counts)
tpm_log2_anno <- Run_annotation(gtf_inf = gtf, matrix = tpm_log2)
vsd_anno <- Run_annotation(gtf_inf = gtf, matrix = vsd)
qs::qsave(vsd_anno, file = "02_annotated_expression_matrices/vsd.qs")
dev.off()
devtools::build()
devtools::install_local("/media/desk16/iyun4605/public_data/YuhengTao_Rpackages/EnrichExplainer_0.1.1.tar.gz",force = T)
devtools::build()
devtools::install_local("/media/desk16/iyun4605/public_data/YuhengTao_Rpackages/EnrichExplainer_0.1.1.tar.gz", dependence = T, upgrade = F, force = T)
devtools::install_local("/media/desk16/iyun4605/public_data/YuhengTao_Rpackages/EnrichExplainer_0.1.1.tar.gz", dependencies = T, upgrade = F, force = T)
devtools::load_all()
setwd("~/public_data/YuhengTao_Rpackages/packages_writing_workplace")
library(clusterProfiler)
library(tidyverse)
deseq2_res <- readRDS("data/deseq2_res.rds")
gsea_go <- readRDS("data/gsea_go.rds")
gsea_kegg <- readRDS("data/gsea_kegg.rds")
# genes <- strsplit(res$core_enrichment, split = "/") %>% unlist() %>% unique()
deseq2_res <- deseq2_res %>% dplyr::filter(padj < 0.05 & log2FoldChange > 1)
diff_genes <- deseq2_res$log2FoldChange
names(diff_genes) <- deseq2_res$gene
diff_genes <- sort(diff_genes, decreasing = T)
prompt <- interpret_tool(enrich_res = gsea_go,
diff_genes = diff_genes,
database = "GO",
pathway_num = 50,
context = NULL,
ppi = TRUE,
organism = "hsa",
ppi_limit = NULL,
contact_LLM = FALSE,
api_key = "1443cf91-00bd-4c0d-b532-284ed5afec11",
model="deepseek-r1-250528")
devtools::load_all()
setwd("~/public_data/YuhengTao_Rpackages/EnrichExplainer")
devtools::load_all()
prompt <- interpret_tool(enrich_res = gsea_go,
diff_genes = diff_genes,
database = "GO",
pathway_num = 50,
context = NULL,
ppi = TRUE,
organism = "hsa",
ppi_limit = NULL,
contact_LLM = FALSE,
api_key = "1443cf91-00bd-4c0d-b532-284ed5afec11",
model="deepseek-r1-250528")
devtools::load_all()
prompt <- interpret_tool(enrich_res = gsea_go,
diff_genes = diff_genes,
database = "GO",
pathway_num = 50,
context = NULL,
ppi = TRUE,
organism = "hsa",
ppi_limit = NULL,
contact_LLM = FALSE,
api_key = "1443cf91-00bd-4c0d-b532-284ed5afec11",
model="deepseek-r1-250528")
devtools::load_all()
prompt <- interpret_tool(enrich_res = gsea_go,
diff_genes = diff_genes,
database = "GO",
pathway_num = 50,
context = NULL,
ppi = TRUE,
organism = "hsa",
ppi_limit = NULL,
contact_LLM = FALSE,
api_key = "1443cf91-00bd-4c0d-b532-284ed5afec11",
model="deepseek-r1-250528")
devtools::load_all()
prompt <- interpret_tool(enrich_res = gsea_go,
diff_genes = diff_genes,
database = "GO",
pathway_num = 50,
context = NULL,
ppi = TRUE,
organism = "hsa",
ppi_limit = NULL,
contact_LLM = FALSE,
api_key = "1443cf91-00bd-4c0d-b532-284ed5afec11",
model="deepseek-r1-250528")
ora_go <- readRDS("data/ora_go.rds")
prompt <- interpret_tool(enrich_res = ora_go,
diff_genes = diff_genes,
database = "GO",
pathway_num = 50,
context = NULL,
ppi = TRUE,
organism = "hsa",
ppi_limit = NULL,
contact_LLM = FALSE,
api_key = "1443cf91-00bd-4c0d-b532-284ed5afec11",
model="deepseek-r1-250528")
cat(prompt)
interpret_tool(enrich_res = compare_kegg,
diff_genes = diff_genes,
database = "KEGG",
pathway_num = 20,
context = NULL,
ppi = TRUE,
organism = "hsa",
ppi_limit = NULL,
contact_LLM = FALSE,
api_key = "1443cf91-00bd-4c0d-b532-284ed5afec11",
model="deepseek-r1-250528")
compare_kegg <- readRDS("data/comparecluter_enrichKEGG.rds")
setwd("~/public_data/YuhengTao_Rpackages/packages_writing_workplace")
compare_kegg <- readRDS("data/comparecluter_enrichKEGG.rds")
prompt <- interpret_tool(enrich_res = compare_kegg,
diff_genes = diff_genes,
database = "KEGG",
pathway_num = 20,
context = NULL,
ppi = TRUE,
organism = "hsa",
ppi_limit = NULL,
contact_LLM = FALSE,
api_key = "1443cf91-00bd-4c0d-b532-284ed5afec11",
model="deepseek-r1-250528")
View(prompt)
setwd("~/public_data/YuhengTao_Rpackages/EnrichExplainer")
devtools::build()
devtools::install_local("/media/desk16/iyun4605/public_data/YuhengTao_Rpackages/EnrichExplainer_0.1.1.tar.gz", dependencies = T, force = T, upgrade = F)
devtools::build()
devtools::install_local("/media/desk16/iyun4605/public_data/YuhengTao_Rpackages/EnrichExplainer_0.1.1.tar.gz", dependences = T, force = T, upgrade = F)
devtools::install_local("/media/desk16/iyun4605/public_data/YuhengTao_Rpackages/EnrichExplainer_0.1.1.tar.gz", dependencies = T, force = T, upgrade = F)
devtools::document()
devtools::load_all()
?interpret_tool
devtools::document()
devtools::load_all()
?interpret_tool
devtools::build()
devtools::install_local("/media/desk16/iyun4605/public_data/YuhengTao_Rpackages/EnrichExplainer_0.1.1.tar.gz", dependencies = T,)
devtools::install_local("/media/desk16/iyun4605/public_data/YuhengTao_Rpackages/EnrichExplainer_0.1.1.tar.gz", dependencies = T, force = T, upgrade = F)
